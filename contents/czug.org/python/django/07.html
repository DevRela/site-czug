<p>第7章：表单处理</p>
<p>客座作者：Simon Willison</p>
<p>&nbsp;&nbsp;&nbsp; 跟随上一章走到现在，你现在应该有一个拥有完整功能的简单网站了。在本章，我们将处理这个谜题的下一个部分：构建视图来获取读者的输入。</p>

<p>&nbsp;&nbsp;&nbsp; 我们将从&ldquo;手动&rdquo;制作一个简单的搜索表单开始来看看如何处理从浏览器提交的数据。从那里，我们将转到使用Django的表单框架。</p>
<p>搜索</p>
<p>&nbsp;&nbsp;&nbsp; Web中到处存在搜索。网络中两个最大的成功故事，Google和Yahoo，围绕着搜索构建了他们几十亿美元的业务。几乎每个网站的很大比例的进出流量都来自于它们的搜索页面。通常在一个站点的成功与失败之间的区别是它们的搜索的质量。所以看起来我们最好给我们的初级书籍站点添加搜索，不是么？</p>
<p>&nbsp;&nbsp;&nbsp; 我们将从给我们的URLconf(mysite.urls)添加搜索视图开始。记住这意味着要在URL模式集合中添加某些类似<tt>(r'^search/$', 'mysite.books.views.search')</tt>的东西。</p>
<p>&nbsp;&nbsp;&nbsp; 接下来，我们将把这个搜索视图写入到我们的模块中(mysite.books.views):</p>

<pre>from django.db.models <span style="color: rgb(0, 0, 255);">import</span> Q<br />from django.shortcuts <span style="color: rgb(0, 0, 255);">import</span> render_to_response<br />from models <span style="color: rgb(0, 0, 255);">import</span> Book<br /><br /><span style="color: rgb(0, 0, 255);">def</span> <span style="color: rgb(0, 0, 255);">search</span>(request):<br />    query = request.GET.get('q', '')<br />    <span style="color: rgb(0, 0, 255);">if</span> query:<br />        qset = (<br />            Q(title__icontains=query) |<br />            Q(authors__first_name__icontains=query) |<br />            Q(authors__last_name__icontains=query)<br />        )<br />        results = Book.objects.filter(qset).distinct()<br />    <span style="color: rgb(0, 0,
255);">else</span>:<br />        results = []<br />    <span style="color: rgb(0, 0, 255);">return</span> render_to_response(&quot;<span style="color: rgb(139, 0, 0);">books/search.html</span>&quot;, {<br />        &quot;<span style="color: rgb(139, 0, 0);">results</span>&quot;: results,<br />        &quot;<span style="color: rgb(139, 0, 0);">query</span>&quot;: query<br />    })</pre>

<p>&nbsp;&nbsp;&nbsp; 这里有几件事情是你还没有见到过的。首先，有<tt>request.GET。这是你从Django中访问GET数据的方法；POST数据是通过一个类似的<tt>request.POST</tt>对象来访问的。这些对象的行为和标准的Python字典及其相似，一些额外的特性将在附录H介绍。</tt></p>
<p><tt>什么是GET和POST数据？</tt></p>
<p><tt>&nbsp;&nbsp;&nbsp; GET和POST是浏览器用来发送数据到服务器的两个方法。多数时间，你将在HTML表单标签中见到它们：</tt></p>
<pre><span style="color: rgb(0, 0, 255);">&lt;</span><span style="color: rgb(128, 0, 0);">form</span> <span style="color: rgb(255, 0, 0);">action</span>=<span style="color: rgb(0, 0, 255);">&quot;/books/search/&quot;</span> <span style="color: rgb(255, 0, 0);">method</span>=<span style="color: rgb(0, 0, 255);">&quot;get&quot;</span><span style="color: rgb(0, 0, 255);">&gt;</span></pre>

<p><font face="Courier New">&nbsp;&nbsp;&nbsp; 这告诉浏览器使用GET方法将表单数据提交给URL <tt>/books/search/。</tt></font></p>
<p><font face="Courier New"><tt>&nbsp;&nbsp;&nbsp; GET和POST方法在语义上有重要的区别，我们现在不会讨论，不过如果你想学习更多的内容请参看<a href="http://www.w3.org/2001/tag/doc/whenToUseGet.html">http://www.w3.org/2001/tag/doc/whenToUseGet.html</a>。</tt></font></p>
<p><font face="Courier New"><tt>&nbsp;&nbsp;&nbsp; 所以这行代码：</tt></font></p>
<pre>query = request.GET.get('q', '')</pre>
<p><font face="Courier New">&nbsp;&nbsp;&nbsp; 查找GET方法的名为'q'的参数，如果这个参数没有被提交就返回一个空字符串。</font></p>

<p><font face="Courier New">&nbsp;&nbsp;&nbsp; 注意我们正在对request.GET对象使用get()方法，有点隐晦。这里的get()方法是每一个Python字典都有的。我们在这里很小心地使用它：它是不安全的，它假定request.GET对象包含有一个'q'键，所以我们使用get('q','')来提供''（空字符串）作为默认返回值。如果我们只是使用request.GET['q']来访问这个变量，如果q在GET数据中不可用，这些代码将会引发一个KeyError异常。</font></p>
<p><font face="Courier New">&nbsp;&nbsp;&nbsp; 第二，Q是什么？Q对象被用来构建复杂的查询&mdash;&mdash;在这个例子中，我们搜索任何标题或者任何一位作者的名字匹配查询字符串的书籍。技术上讲，这些Q对象包含一个查询集合，你可以在附录C中获取更多信息。</font></p>
<p><font face="Courier New">&nbsp;&nbsp;&nbsp; 在这些查询中，<tt>icontains</tt>是一种大小写不敏感的查询，在底层数据库中使用SQL 的LIKE操作符。</font></p>
<p><font face="Courier New">&nbsp;&nbsp;&nbsp; 因为我们正在搜索一个多对多的域，很可能同一本书会在一次查询中被返回多次（例如，一本书的两个作者都匹配查询字符串）。在过滤器末尾添加<tt>.distinct()</tt>用来过滤重复的结果。</font></p>

<p><font face="Courier New">&nbsp;&nbsp;&nbsp; 然而，现在还没有对应此搜索视图的模板。下面的代码将做这件事：</font></p>
<pre><span style="color: rgb(0, 0, 255);">&lt;</span>!DOCTYPE HTML PUBLIC &quot;-//W3C//DTD HTML 4.01//EN&quot;<span style="color: rgb(0, 0, 255);">&gt;</span><br /><span style="color: rgb(0, 0, 255);">&lt;</span><span style="color: rgb(128, 0, 0);">html</span> <span style="color: rgb(255, 0, 0);">lang</span>=<span style="color: rgb(0, 0, 255);">&quot;en&quot;</span><span style="color: rgb(0, 0, 255);">&gt;</span><br /><span style="color: rgb(0, 0, 255);">&lt;</span><span style="color: rgb(128, 0, 0);">head</span><span style="color: rgb(0, 0, 255);">&gt;</span><br />    <span style="color: rgb(0, 0, 255);">&lt;</span><span style="color: rgb(128, 0, 0);">title</span><span style="color: rgb(0, 0, 255);">&gt;</span>Search{% if query %} Results{% endif %}<span style="color: rgb(0,
0, 255);"><!--</span--><span style="color: rgb(128, 0, 0);">title</span><span style="color: rgb(0, 0, 255);">&gt;</span><br /><span style="color: rgb(0, 0, 255);"><!--</span--><span style="color: rgb(128, 0, 0);">head</span><span style="color: rgb(0, 0, 255);">&gt;</span><br /><span style="color: rgb(0, 0, 255);">&lt;</span><span style="color: rgb(128, 0, 0);">body</span><span style="color: rgb(0, 0, 255);">&gt;</span><br />  <span style="color: rgb(0, 0, 255);">&lt;</span><span style="color: rgb(128, 0, 0);">h1</span><span style="color: rgb(0, 0, 255);">&gt;</span>Search<span style="color: rgb(0, 0, 255);"><!--</span--><span style="color: rgb(128, 0, 0);">h1</span><span style="color: rgb(0, 0, 255);">&gt;</span><br />  <span style="color: rgb(0, 0, 255);">&lt;</span><span
style="color: rgb(128, 0, 0);">form</span> <span style="color: rgb(255, 0, 0);">action</span>=<span style="color: rgb(0, 0, 255);">&quot;.&quot;</span> <span style="color: rgb(255, 0, 0);">method</span>=<span style="color: rgb(0, 0, 255);">&quot;GET&quot;</span><span style="color: rgb(0, 0, 255);">&gt;</span><br />    <span style="color: rgb(0, 0, 255);">&lt;</span><span style="color: rgb(128, 0, 0);">label</span> <span style="color: rgb(255, 0, 0);">for</span>=<span style="color: rgb(0, 0, 255);">&quot;q&quot;</span><span style="color: rgb(0, 0, 255);">&gt;</span>Search: <span style="color: rgb(0, 0, 255);"><!--</span--><span style="color: rgb(128, 0, 0);">label</span><span style="color: rgb(0, 0, 255);">&gt;</span><br />    <span style="color: rgb(0, 0,
255);">&lt;</span><span style="color: rgb(128, 0, 0);">input</span> <span style="color: rgb(255, 0, 0);">type</span>=<span style="color: rgb(0, 0, 255);">&quot;text&quot;</span> <span style="color: rgb(255, 0, 0);">name</span>=<span style="color: rgb(0, 0, 255);">&quot;q&quot;</span> <span style="color: rgb(255, 0, 0);">value</span>=<span style="color: rgb(0, 0, 255);">&quot;{{ query|escape }}&quot;</span><span style="color: rgb(0, 0, 255);">&gt;</span><br />    <span style="color: rgb(0, 0, 255);">&lt;</span><span style="color: rgb(128, 0, 0);">input</span> <span style="color: rgb(255, 0, 0);">type</span>=<span style="color: rgb(0, 0, 255);">&quot;submit&quot;</span> <span style="color: rgb(255, 0, 0);">value</span>=<span style="color: rgb(0, 0,
255);">&quot;Search&quot;</span><span style="color: rgb(0, 0, 255);">&gt;</span><br />  <span style="color: rgb(0, 0, 255);"><!--</span--><span style="color: rgb(128, 0, 0);">form</span><span style="color: rgb(0, 0, 255);">&gt;</span><br /><br />  {% if query %}<br />    <span style="color: rgb(0, 0, 255);">&lt;</span><span style="color: rgb(128, 0, 0);">h2</span><span style="color: rgb(0, 0, 255);">&gt;</span>Results for &quot;{{ query|escape }}&quot;:<span style="color: rgb(0, 0, 255);"><!--</span--><span style="color: rgb(128, 0, 0);">h2</span><span style="color: rgb(0, 0, 255);">&gt;</span><br /><br />    {% if results %}<br />      <span style="color: rgb(0, 0, 255);">&lt;</span><span style="color: rgb(128, 0, 0);">ul</span><span style="color: rgb(0, 0,
255);">&gt;</span><br />      {% for book in results %}<br />        <span style="color: rgb(0, 0, 255);">&lt;</span><span style="color: rgb(128, 0, 0);">li</span><span style="color: rgb(0, 0, 255);">&gt;</span>{{ book|escape }}<span style="color: rgb(0, 0, 255);"><!--</span--><span style="color: rgb(128, 0, 0);">l1</span><span style="color: rgb(0, 0, 255);">&gt;</span><br />      {% endfor %}<br />      <span style="color: rgb(0, 0, 255);"><!--</span--><span style="color: rgb(128, 0, 0);">ul</span><span style="color: rgb(0, 0, 255);">&gt;</span><br />    {% else %}<br />      <span style="color: rgb(0, 0, 255);">&lt;</span><span style="color: rgb(128, 0, 0);">p</span><span style="color: rgb(0, 0, 255);">&gt;</span>No books found<span style="color: rgb(0, 0,
255);"><!--</span--><span style="color: rgb(128, 0, 0);">p</span><span style="color: rgb(0, 0, 255);">&gt;</span><br />    {% endif %}<br />  {% endif %}<br /><span style="color: rgb(0, 0, 255);"><!--</span--><span style="color: rgb(128, 0, 0);">body</span><span style="color: rgb(0, 0, 255);">&gt;</span><br /><span style="color: rgb(0, 0, 255);"><!--</span--><span style="color: rgb(128, 0, 0);">html</span><span style="color: rgb(0, 0, 255);">&gt;</span></span></span></span></span></span></span></span></span></span></span></span></pre>

<p><font face="Courier New">&nbsp;&nbsp;&nbsp; 希望到现在为止一切都是显而易见的。不过，还是有一些细微之处值得指出：</font></p>
<ul>
    <li><font face="Courier New">表单的动作是.，意思是&quot;当前URL&quot;。这是一个标准的最佳实践：不要对表单页面和结果页面使用分开的单独的视图；使用同一个来处理表单和搜索结果。</font> </li>
        <li><font face="Courier New">我们将查询字符串的值重新插入<input />。这会帮助读者很容易地调整他们的搜索而不用重新输入他们的搜索。</font> </li>
            <li><font face="Courier New">在每个使用query和book的地方，我们都将它们传递通过escape过滤器来确保任何潜在的恶意搜索文本在插入页面之前都被过滤掉了。</font> </li>

            </ul>
            <p><font face="Courier New">&nbsp;&nbsp;&nbsp; 对于任何用户提交的内容都使用它（escape过滤器）是极为必要的。否则你就让你的站点对跨站脚本攻击敞开了大门。第19章会详细讨论跨站脚本攻击(XSS)和安全。</font></p>
            <ul>
                <li><font face="Courier New">不过，我们不需要为你的数据库查询中的有害内容担忧&mdash;&mdash;我们只需简单地将查询字符串原样传递给查询过程。这是因为Django的数据库层为你处理了这方面的安全。</font> </li>
                </ul>
                <p><font face="Courier New">&nbsp;&nbsp;&nbsp; 现在我们有了一个可以工作的搜索了。更进一步的改进是把搜索表单添加到每一个页面（例如，在基本模板中）；我们会留给你自己来处理。</font></p>
                <p><font face="Courier New">&nbsp;&nbsp;&nbsp; 接下来，我们会看一个更复杂的例子。但是在开市之前，让我们讨论一个更抽象的话题：&ldquo;最好的表单。&rdquo;</font></p>

                <p><font face="Courier New">&ldquo;最好的表单&rdquo;</font></p>
                <p><font face="Courier New">&nbsp;&nbsp;&nbsp; 表单常常是让你的网站用户受挫的主要原因。让我们考虑一个理想中最好的表单的行为：</font></p>
                <ul>
                    <li><font face="Courier New">显然，它应该询问用户一些信息。易用性和可用性在这里是很重要的，所以灵活使用HTML的<label>元素和条理清晰的帮助信息是很重要的。</label></font> </li>
                        <li><font face="Courier New">提交的数据应该被施以充分的验证。Web应用安全的金科玉律是&ldquo;永远不要相信输入数据&rdquo;，所以验证是必不可少的。</font> </li>

                            <li><font face="Courier New">如果用户翻了任何错误，表单应该给出详细的提示性的错误信息并重新显示。原来的数据应该预先填好，以避免用户逐一重新输入所有东西。</font> </li>
                                <li><font face="Courier New">表单应该一直重新显示，直到表单中所有的域都被正确地填充了。</font> </li>
                                </ul>
                                <p><font face="Courier New">&nbsp;&nbsp;&nbsp; 构建最好的表单看起来好像是大量的工作！谢天谢地，Django的表单框架被设计为替你处理大部分的工作。你只需提供表单域的描述，验证规则，和一个简单的模板，其余的Django会处理。结果是只需很少的努力便得到&ldquo;最好的表单&rdquo;。</font></p>
                                <p><font face="Courier New">创建一个反馈表单</font></p>
                                <p><font face="Courier New">&nbsp;&nbsp;&nbsp; 构建一个人们喜爱的站点的最好途径是聆听他们的反馈。许多站点好像忘记了这一点；他们把他们的详细联系方式隐藏到FAQ之后，并且看起来他们是让与真人接触尽可能地难。</font></p>

                                <p><font face="Courier New">&nbsp;&nbsp;&nbsp; 当你的站点有数以百万计的用户，这样的战略或许是合理的。可是，当你试图建立起一个用户群的时候，你应该尽可能地抓住每一个机会鼓励反馈信息。让我们建立一个简单的反馈表单并用它来实际地说明Django的表单框架。</font></p>
                                <p><font face="Courier New">&nbsp;&nbsp;&nbsp; 我们将从添加<tt>(r'^contact/$', 'mysite.books.views.contact')</tt>到我们的URLconf开始，然后定义我们的表单。表单在Django中的创建方式类似于模型：声明，使用一个Python类。这里是我们的简单的表单的类。按照惯例，我们将把它插入到我们的应用目录中的一个新文件forms.py：</font></p>
                                <pre>from django <span style="color: rgb(0, 0, 255);">import</span> newforms as forms<br /><br />TOPIC_CHOICES = (<br />    ('general', 'General enquiry'),<br />    ('bug', 'Bug report'),<br />    ('suggestion', 'Suggestion'),<br />)<br /><br /><span style="color: rgb(0, 0, 255);">class</span> ContactForm(forms.Form):<br />    topic = forms.ChoiceField(choices=TOPIC_CHOICES)<br />    message = forms.CharField()<br />    sender = forms.EmailField(required=False)</pre>

                                <p><font face="Courier New">&ldquo;新&rdquo;表单？什么？</font></p>
                                <p><font face="Courier New">&nbsp;&nbsp;&nbsp; 当Django第一次公开发布时，它有一个复杂的，难以理解的表单系统。它使得产生表单非常困难，所以它被完全地重写了，现在被叫做&quot;newforms&quot;。不过，仍然有大量代码是基于&ldquo;旧&rdquo;表单系统的，所以到现在为止Django在两种表单包之间过渡。</font></p>
                                <p><font face="Courier New">&nbsp;&nbsp;&nbsp; 到本书写作时为止，Django的旧表单系统仍然作为django.forms可用，新表单包是django.newforms。某些地方改变了并且django.forms将会指向新的表单包。不过，为了确保本书中的例子能够尽可能广泛地工作，所有的例子会引用django.newforms。</font></p>
                                <p><font face="Courier New">&nbsp;&nbsp;&nbsp; Django的表单是django.newforms.Form的子类，就像Django模型是django.db.models.Model的子类。django.newforms模块也包含一些Field类；完整的列表在Django的文章网站<a href="http://www.djangoproject.com/documentation/0.96/newforms/">http://www.djangoproject.com/documentation/0.96/newforms/</a>可用。</font></p>

                                <p><font face="Courier New">&nbsp;&nbsp;&nbsp; 我们的<tt>ContactForm</tt>由3个域组成：话题，从三个选项中选择；消息，是一个字符域；发送者，是一个电子邮件域并且是可选的（因为即使是匿名的用户也是有用的）。还有其他的一些域类型可以使用，并且如果它们不满足你的需要你可以编写你自己的类型。</font></p>
                                <p><font face="Courier New">&nbsp;&nbsp;&nbsp; 表单对象本身知道怎样去做一些有用的事情。它可以验证一个数据的收集，它可以生成自己的HTML&quot;小部件&quot;，它可以构建一个有用的出错信息的集合，并且，如果我们比较懒，它还可以为我们绘制整个表单。让我们把它挂接到一个视图来实际地看看它。在views.py中：</font></p>
                                <pre>from django.db.models <span style="color: rgb(0, 0, 255);">import</span> Q<br />from django.shortcuts <span style="color: rgb(0, 0, 255);">import</span> render_to_response<br />from models <span style="color: rgb(0, 0, 255);">import</span> Book<br />from forms <span style="color: rgb(0, 0, 255);">import</span> ContactForm<br /><br /><span style="color: rgb(0, 0, 255);">def</span> <span style="color: rgb(0, 0, 255);">search</span>(request):<br />    query = request.GET.get('q', '')<br />    <span style="color: rgb(0, 0, 255);">if</span> query:<br />        qset = (<br />            Q(title__icontains=query) |<br />            Q(authors__first_name__icontains=query) |<br />            Q(authors__last_name__icontains=query)<br />        )<br />
                                results = Book.objects.filter(qset).distinct()<br />    <span style="color: rgb(0, 0, 255);">else</span>:<br />        results = []<br />    <span style="color: rgb(0, 0, 255);">return</span> render_to_response(&quot;<span style="color: rgb(139, 0, 0);">books/search.html</span>&quot;, {<br />        &quot;<span style="color: rgb(139, 0, 0);">results</span>&quot;: results,<br />        &quot;<span style="color: rgb(139, 0, 0);">query</span>&quot;: query<br />    })<br /><br /><span style="color: rgb(0, 0, 255);">def</span> contact(request):<br />    form = ContactForm()<br />    <span style="color: rgb(0, 0, 255);">return</span> render_to_response('contact.html', {'form': form})</pre>

                                <p><font face="Courier New">&nbsp;&nbsp;&nbsp; 并且在<tt>contact.html</tt>中：</font></p>
                                <pre><span style="color: rgb(0, 0, 255);">&lt;</span>!DOCTYPE HTML PUBLIC &quot;-//W3C//DTD HTML 4.01//EN&quot;<span style="color: rgb(0, 0, 255);">&gt;</span><br /><span style="color: rgb(0, 0, 255);">&lt;</span><span style="color: rgb(128, 0, 0);">html</span> <span style="color: rgb(255, 0, 0);">lang</span>=<span style="color: rgb(0, 0, 255);">&quot;en&quot;</span><span style="color: rgb(0, 0, 255);">&gt;</span><br /><span style="color: rgb(0, 0, 255);">&lt;</span><span style="color: rgb(128, 0, 0);">head</span><span style="color: rgb(0, 0, 255);">&gt;</span><br />    <span style="color: rgb(0, 0, 255);">&lt;</span><span style="color: rgb(128, 0, 0);">title</span><span style="color: rgb(0, 0, 255);">&gt;</span>Contact us<span style="color:
                                rgb(0, 0, 255);"><!--</span--><span style="color: rgb(128, 0, 0);">title</span><span style="color: rgb(0, 0, 255);">&gt;</span><br /><span style="color: rgb(0, 0, 255);"><!--</span--><span style="color: rgb(128, 0, 0);">head</span><span style="color: rgb(0, 0, 255);">&gt;</span><br /><span style="color: rgb(0, 0, 255);">&lt;</span><span style="color: rgb(128, 0, 0);">body</span><span style="color: rgb(0, 0, 255);">&gt;</span><br />    <span style="color: rgb(0, 0, 255);">&lt;</span><span style="color: rgb(128, 0, 0);">h1</span><span style="color: rgb(0, 0, 255);">&gt;</span>Contact us<span style="color: rgb(0, 0, 255);"><!--</span--><span style="color: rgb(128, 0, 0);">h1</span><span style="color: rgb(0, 0, 255);">&gt;</span><br />    <span
                                style="color: rgb(0, 0, 255);">&lt;</span><span style="color: rgb(128, 0, 0);">form</span> <span style="color: rgb(255, 0, 0);">action</span>=<span style="color: rgb(0, 0, 255);">&quot;.&quot;</span> <span style="color: rgb(255, 0, 0);">method</span>=<span style="color: rgb(0, 0, 255);">&quot;POST&quot;</span><span style="color: rgb(0, 0, 255);">&gt;</span><br />        <span style="color: rgb(0, 0, 255);">&lt;</span><span style="color: rgb(128, 0, 0);">table</span><span style="color: rgb(0, 0, 255);">&gt;</span><br />            {{ form.as_table }}<br />        <span style="color: rgb(0, 0, 255);"><!--</span--><span style="color: rgb(128, 0, 0);">table</span><span style="color: rgb(0, 0, 255);">&gt;</span><br />        <span style="color: rgb(0,
                                0, 255);">&lt;</span><span style="color: rgb(128, 0, 0);">p</span><span style="color: rgb(0, 0, 255);">&gt;</span><span style="color: rgb(0, 0, 255);">&lt;</span><span style="color: rgb(128, 0, 0);">input</span> <span style="color: rgb(255, 0, 0);">type</span>=<span style="color: rgb(0, 0, 255);">&quot;submit&quot;</span> <span style="color: rgb(255, 0, 0);">value</span>=<span style="color: rgb(0, 0, 255);">&quot;Submit&quot;</span><span style="color: rgb(0, 0, 255);">&gt;</span><span style="color: rgb(0, 0, 255);"><!--</span--><span style="color: rgb(128, 0, 0);">p</span><span style="color: rgb(0, 0, 255);">&gt;</span><br />    <span style="color: rgb(0, 0, 255);"><!--</span--><span style="color: rgb(128, 0, 0);">form</span><span style="color:
                                rgb(0, 0, 255);">&gt;</span><br /><span style="color: rgb(0, 0, 255);"><!--</span--><span style="color: rgb(128, 0, 0);">body</span><span style="color: rgb(0, 0, 255);">&gt;</span><br /><span style="color: rgb(0, 0, 255);"><!--</span--><span style="color: rgb(128, 0, 0);">html</span><span style="color: rgb(0, 0, 255);">&gt;</span></span></span></span></span></span></span></span></span></pre>

                                <p><font face="Courier New">&nbsp;&nbsp;&nbsp; 这里最有趣的一行是<tt>{{ form.as_table }}。</tt>form是我们的ContactForm实例，传递到<tt>render_to_response</tt>。as_table是一个将表单渲染为表格的行序列的方法(as_ul和as_p也可以被使用)。生成的HTML看起来是这样的：</font></p>
                                <pre><span style="color: rgb(0, 0, 255);">&lt;</span><span style="color: rgb(128, 0, 0);">tr</span><span style="color: rgb(0, 0, 255);">&gt;</span><br />    <span style="color: rgb(0, 0, 255);">&lt;</span><span style="color: rgb(128, 0, 0);">th</span><span style="color: rgb(0, 0, 255);">&gt;</span><span style="color: rgb(0, 0, 255);">&lt;</span><span style="color: rgb(128, 0, 0);">label</span> <span style="color: rgb(255, 0, 0);">for</span>=<span style="color: rgb(0, 0, 255);">&quot;id_topic&quot;</span><span style="color: rgb(0, 0, 255);">&gt;</span>Topic:<span style="color: rgb(0, 0, 255);"><!--</span--><span style="color: rgb(128, 0, 0);">label</span><span style="color: rgb(0, 0, 255);">&gt;</span><span style="color: rgb(0, 0,
                                255);"><!--</span--><span style="color: rgb(128, 0, 0);">th</span><span style="color: rgb(0, 0, 255);">&gt;</span><br />    <span style="color: rgb(0, 0, 255);">&lt;</span><span style="color: rgb(128, 0, 0);">td</span><span style="color: rgb(0, 0, 255);">&gt;</span><br />        <span style="color: rgb(0, 0, 255);">&lt;</span><span style="color: rgb(128, 0, 0);">select</span> <span style="color: rgb(255, 0, 0);">name</span>=<span style="color: rgb(0, 0, 255);">&quot;topic&quot;</span> <span style="color: rgb(255, 0, 0);">id</span>=<span style="color: rgb(0, 0, 255);">&quot;id_topic&quot;</span><span style="color: rgb(0, 0, 255);">&gt;</span><br />            <span style="color: rgb(0, 0, 255);">&lt;</span><span style="color: rgb(128, 0,
                                0);">option</span> <span style="color: rgb(255, 0, 0);">value</span>=<span style="color: rgb(0, 0, 255);">&quot;general&quot;</span><span style="color: rgb(0, 0, 255);">&gt;</span>General enquiry<span style="color: rgb(0, 0, 255);"><!--</span--><span style="color: rgb(128, 0, 0);">option</span><span style="color: rgb(0, 0, 255);">&gt;</span><br />            <span style="color: rgb(0, 0, 255);">&lt;</span><span style="color: rgb(128, 0, 0);">option</span> <span style="color: rgb(255, 0, 0);">value</span>=<span style="color: rgb(0, 0, 255);">&quot;bug&quot;</span><span style="color: rgb(0, 0, 255);">&gt;</span>Bug report<span style="color: rgb(0, 0, 255);"><!--</span--><span style="color: rgb(128, 0, 0);">option</span><span style="color: rgb(0, 0,
                                255);">&gt;</span><br />            <span style="color: rgb(0, 0, 255);">&lt;</span><span style="color: rgb(128, 0, 0);">option</span> <span style="color: rgb(255, 0, 0);">value</span>=<span style="color: rgb(0, 0, 255);">&quot;suggestion&quot;</span><span style="color: rgb(0, 0, 255);">&gt;</span>Suggestion<span style="color: rgb(0, 0, 255);"><!--</span--><span style="color: rgb(128, 0, 0);">option</span><span style="color: rgb(0, 0, 255);">&gt;</span><br />        <span style="color: rgb(0, 0, 255);"><!--</span--><span style="color: rgb(128, 0, 0);">select</span><span style="color: rgb(0, 0, 255);">&gt;</span><br />    <span style="color: rgb(0, 0, 255);"><!--</span--><span style="color: rgb(128, 0, 0);">td</span><span style="color: rgb(0, 0,
                                255);">&gt;</span><br /><span style="color: rgb(0, 0, 255);"><!--</span--><span style="color: rgb(128, 0, 0);">tr</span><span style="color: rgb(0, 0, 255);">&gt;</span><br /><span style="color: rgb(0, 0, 255);">&lt;</span><span style="color: rgb(128, 0, 0);">tr</span><span style="color: rgb(0, 0, 255);">&gt;</span><br />    <span style="color: rgb(0, 0, 255);">&lt;</span><span style="color: rgb(128, 0, 0);">th</span><span style="color: rgb(0, 0, 255);">&gt;</span><span style="color: rgb(0, 0, 255);">&lt;</span><span style="color: rgb(128, 0, 0);">label</span> <span style="color: rgb(255, 0, 0);">for</span>=<span style="color: rgb(0, 0, 255);">&quot;id_message&quot;</span><span style="color: rgb(0, 0, 255);">&gt;</span>Message:<span style="color:
                                rgb(0, 0, 255);"><!--</span--><span style="color: rgb(128, 0, 0);">label</span><span style="color: rgb(0, 0, 255);">&gt;</span><span style="color: rgb(0, 0, 255);"><!--</span--><span style="color: rgb(128, 0, 0);">th</span><span style="color: rgb(0, 0, 255);">&gt;</span><br />    <span style="color: rgb(0, 0, 255);">&lt;</span><span style="color: rgb(128, 0, 0);">td</span><span style="color: rgb(0, 0, 255);">&gt;</span><span style="color: rgb(0, 0, 255);">&lt;</span><span style="color: rgb(128, 0, 0);">input</span> <span style="color: rgb(255, 0, 0);">type</span>=<span style="color: rgb(0, 0, 255);">&quot;text&quot;</span> <span style="color: rgb(255, 0, 0);">name</span>=<span style="color: rgb(0, 0, 255);">&quot;message&quot;</span> <span
                                style="color: rgb(255, 0, 0);">id</span>=<span style="color: rgb(0, 0, 255);">&quot;id_message&quot;</span> <span style="color: rgb(0, 0, 255);">/&gt;</span><span style="color: rgb(0, 0, 255);"><!--</span--><span style="color: rgb(128, 0, 0);">td</span><span style="color: rgb(0, 0, 255);">&gt;</span><br /><span style="color: rgb(0, 0, 255);"><!--</span--><span style="color: rgb(128, 0, 0);">tr</span><span style="color: rgb(0, 0, 255);">&gt;</span><br /><span style="color: rgb(0, 0, 255);">&lt;</span><span style="color: rgb(128, 0, 0);">tr</span><span style="color: rgb(0, 0, 255);">&gt;</span><br />    <span style="color: rgb(0, 0, 255);">&lt;</span><span style="color: rgb(128, 0, 0);">th</span><span style="color: rgb(0, 0, 255);">&gt;</span><span
                                style="color: rgb(0, 0, 255);">&lt;</span><span style="color: rgb(128, 0, 0);">label</span> <span style="color: rgb(255, 0, 0);">for</span>=<span style="color: rgb(0, 0, 255);">&quot;id_sender&quot;</span><span style="color: rgb(0, 0, 255);">&gt;</span>Sender:<span style="color: rgb(0, 0, 255);"><!--</span--><span style="color: rgb(128, 0, 0);">label</span><span style="color: rgb(0, 0, 255);">&gt;</span><span style="color: rgb(0, 0, 255);"><!--</span--><span style="color: rgb(128, 0, 0);">th</span><span style="color: rgb(0, 0, 255);">&gt;</span><br />    <span style="color: rgb(0, 0, 255);">&lt;</span><span style="color: rgb(128, 0, 0);">td</span><span style="color: rgb(0, 0, 255);">&gt;</span><span style="color: rgb(0, 0, 255);">&lt;</span><span
                                style="color: rgb(128, 0, 0);">input</span> <span style="color: rgb(255, 0, 0);">type</span>=<span style="color: rgb(0, 0, 255);">&quot;text&quot;</span> <span style="color: rgb(255, 0, 0);">name</span>=<span style="color: rgb(0, 0, 255);">&quot;sender&quot;</span> <span style="color: rgb(255, 0, 0);">id</span>=<span style="color: rgb(0, 0, 255);">&quot;id_sender&quot;</span> <span style="color: rgb(0, 0, 255);">/&gt;</span><span style="color: rgb(0, 0, 255);"><!--</span--><span style="color: rgb(128, 0, 0);">td</span><span style="color: rgb(0, 0, 255);">&gt;</span><br /><span style="color: rgb(0, 0, 255);"><!--</span--><span style="color: rgb(128, 0, 0);">tr</span><span style="color: rgb(0, 0,
                                255);">&gt;</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></pre>

                                <p><font face="Courier New">&nbsp;&nbsp;&nbsp; 注意
                                <table>
                                    和
                                        <form>
                                                标签并没有被包含；你需要在模板中自己定义它们，给你了自由来控制当表单被提交的时候的行为。<label>元素被包含，使得表单在盒子之外也可以被访问。  </label>
                                                        <p><font face="Courier New">&nbsp;&nbsp;&nbsp; 我们的表单当前为消息域使用<tt><input type="text" /></tt>小部件。我们不想限制我们的用户只能输入一行文本，所以我们将使用<textarea>小部件来代替：&lt;/font&gt;&lt;/p&gt;  &lt;pre&gt;&lt;span style=&quot;color: #0000ff&quot;&gt;class&lt;/span&gt; ContactForm(forms.Form):     topic = forms.ChoiceField(choices=TOPIC_CHOICES)     message = forms.CharField(widget=forms.Textarea())     sender = forms.EmailField(required=False)&lt;/pre&gt;  &lt;p&gt;&lt;font face=&quot;Courier New&quot;&gt;&nbsp;&nbsp;&nbsp; 表单框架把每个域的表现逻辑分为一个小部件的集合。每个域类型都有一个默认的小部件，但是你可以很容易地覆盖默认值，或者提供一个你自己定制的小部件。&lt;/font&gt;&lt;/p&gt;
                                                        &lt;p&gt;&lt;font face=&quot;Courier New&quot;&gt;&nbsp;&nbsp;&nbsp; 现在，提交这个表单实际上不会做任何事情。让我们添加自己的验证规则：&lt;/font&gt;&lt;/p&gt;  &lt;pre&gt;&lt;span style=&quot;color: #0000ff&quot;&gt;def&lt;/span&gt; contact(request):     &lt;span style=&quot;color: #0000ff&quot;&gt;if&lt;/span&gt; request.method == 'POST':         form = ContactForm(request.POST)     &lt;span style=&quot;color: #0000ff&quot;&gt;else&lt;/span&gt;:         form = ContactForm()     &lt;span style=&quot;color: #0000ff&quot;&gt;return&lt;/span&gt; render_to_response('contact.html', {'form': form})&lt;/pre&gt;  &lt;p&gt;&nbsp;&nbsp;&nbsp;&nbsp;
                                                        一个表单实例可以处在两种状态之一：绑定的和非绑定的。一个绑定的实例是使用字典（或者类似字典的对象）构造并且知道怎样验证和从它们重新显示数据。一个非绑定的表单没有数据和它绑定，它仅仅知道如何显示它自己。&lt;/p&gt;  &lt;p&gt;&nbsp;&nbsp;&nbsp; 尝试输入一个无效的电子邮件地址。&lt;tt&gt;EmailField&lt;/tt&gt;知道如何验证电子邮件地址，至少在一个合理的可接受的水平上。&lt;/p&gt;  &lt;p&gt;设置初始数据&lt;/p&gt;  &lt;p&gt;&nbsp;&nbsp;&nbsp; 直接把数据传递给表单构造器会绑定这个数据并指示应该进行验证。不过，通常我们需要显示一个一些域被预填的初始表单&mdash;&mdash;例如，一个&ldquo;编辑&rdquo;表单。我们可以通过initial关键字参数来做这个：&lt;/p&gt;  &lt;p&gt;form = CommentForm(initial={'sender': &lt;a
                                                        href=&quot;mailto:'user@example.com'&quot; _fcksavedurl=&quot;mailto:'user@example.com'&quot;&gt;'user@example.com'&lt;/a&gt;})&lt;/p&gt;  &lt;p&gt;&nbsp;&nbsp;&nbsp; 如果我们的表单将总是使用相同的默认值，我们可以在表单的定义中配置它们：&lt;/p&gt;  &lt;pre&gt;message = forms.CharField(widget=forms.Textarea(),                           initial=&quot;&lt;span style=&quot;color: #8b0000&quot;&gt;Replace with your feedback&lt;/span&gt;&quot;)&lt;/pre&gt;  &lt;p&gt;处理提交&lt;/p&gt;  &lt;p&gt;&nbsp;&nbsp;&nbsp; 一旦用户填写了表单并且它们通过了我们的验证规则，我们需要用这些数据来做一些有用的事。在这个例子里，我们想要构建并发送一封包含用户反馈的电子邮件。我们将使用Django的email包来做这些。&lt;/p&gt;
                                                        &lt;p&gt;&nbsp;&nbsp;&nbsp;&nbsp; 首先，我们需要知道数据是否确实被验证了，如果是，我们需要访问经过验证的数据。表单框架做了比验证数据更多的事，它也把数据转换为Python的类型。我们的联系人表单仅处理字符串，但是如果我们使用了&lt;tt&gt;IntegerField&lt;/tt&gt; 或者 &lt;tt&gt;DateTimeField，表单框架会确保我们得到一个Python的整数或者datetime对象。&lt;/tt&gt;&lt;/p&gt;  &lt;p&gt;&lt;tt&gt;&nbsp;&nbsp;&nbsp; 为知道表单是否被绑定验证数据，调用is_vaild()方法：&lt;/tt&gt;&lt;/p&gt;  &lt;pre&gt;form = ContactForm(request.POST) &lt;span style=&quot;color: #0000ff&quot;&gt;if&lt;/span&gt; form.is_valid():     # Process form &lt;span style=&quot;color: #0000ff&quot;&gt;data&lt;/span&gt;&lt;/pre&gt;  &lt;p&gt;&lt;font face=&quot;Courier
                                                        New&quot;&gt;&nbsp;&nbsp;&nbsp; 现在我们需要访问数据。我们可以直接从request.POST取出它，但是如果我们这样做，我们会错过由表单框架实施的类型转换。取而代之，我们使用form.clean_fata:&lt;/font&gt;&lt;/p&gt;  &lt;pre&gt;&lt;span style=&quot;color: #0000ff&quot;&gt;if&lt;/span&gt; form.is_valid():     topic = form.clean_data['topic']     message = form.clean_data['message']     sender = form.clean_data.get('sender', 'noreply@example.com')     # ...&lt;/pre&gt;  &lt;p&gt;&lt;font face=&quot;Courier New&quot;&gt;&nbsp;&nbsp;&nbsp;
                                                        注意因为发送人域并不是必需的，当它缺失时我们提供了一个默认值。最后，我们需要记录用户的反馈。做到这一点最简单的途径是用电子邮件把它发送给站点管理员。我们可以使用send_mail函数来做这件事：&lt;/font&gt;&lt;/p&gt;  &lt;pre&gt;from django.core.mail &lt;span style=&quot;color: #0000ff&quot;&gt;import&lt;/span&gt; send_mail  # ...  send_mail(     'Feedback from your &lt;span style=&quot;color: #0000ff&quot;&gt;site&lt;/span&gt;, topic: %s' % topic,     message, sender,     ['administrator@example.com'] )&lt;/pre&gt;  &lt;p&gt;&lt;font face=&quot;Courier New&quot;&gt;&nbsp;&nbsp;&nbsp;
                                                        send_mail函数有四个必需的参数：邮件标题，邮件体，&quot;from&quot;地址，和一个接收者列表。send_mail是Django的&lt;tt&gt;EmailMessage&lt;/tt&gt;类的一个便利的包装形式，&lt;tt&gt;EmailMessage&lt;/tt&gt;提供高级的特性如附件、多块电子邮件、和电子邮件头部的完全控制。&lt;/font&gt;&lt;/p&gt;  &lt;p&gt;&lt;font face=&quot;Courier New&quot;&gt;&nbsp;&nbsp;&nbsp; 发送了电子邮件之后，我们应该将我们的用户重定向到一个静态的确认页面。完成后的视图函数看起来是这样的：&lt;/font&gt;&lt;/p&gt;  &lt;pre&gt;from django.http &lt;span style=&quot;color: #0000ff&quot;&gt;import&lt;/span&gt; HttpResponseRedirect from django.shortcuts &lt;span style=&quot;color: #0000ff&quot;&gt;import&lt;/span&gt; render_to_response from django.core.mail &lt;span
                                                        style=&quot;color: #0000ff&quot;&gt;import&lt;/span&gt; send_mail from forms &lt;span style=&quot;color: #0000ff&quot;&gt;import&lt;/span&gt; ContactForm  &lt;span style=&quot;color: #0000ff&quot;&gt;def&lt;/span&gt; contact(request):     &lt;span style=&quot;color: #0000ff&quot;&gt;if&lt;/span&gt; request.method == 'POST':         form = ContactForm(request.POST)         &lt;span style=&quot;color: #0000ff&quot;&gt;if&lt;/span&gt; form.is_valid():             topic = form.clean_data['topic']             message = form.clean_data['message']             sender = form.clean_data.get('sender', 'noreply@example.com')             send_mail(                 'Feedback from your &lt;span style=&quot;color:
                                                        #0000ff&quot;&gt;site&lt;/span&gt;, topic: %s' % topic,                 message, sender,                 ['administrator@example.com']             )             &lt;span style=&quot;color: #0000ff&quot;&gt;return&lt;/span&gt; HttpResponseRedirect('/contact/thanks/')     &lt;span style=&quot;color: #0000ff&quot;&gt;else&lt;/span&gt;:         form = ContactForm()     &lt;span style=&quot;color: #0000ff&quot;&gt;return&lt;/span&gt; render_to_response('contact.html', {'form': form})&lt;/pre&gt;  &lt;pre&gt;POST之后重定向&lt;/pre&gt;  &lt;p&gt;&nbsp;&nbsp;&nbsp;
                                                        如果用户在页面被POST请求显示过之后选择刷新页面，那么那个请求会被重复。这通常会导致不期望的行为，如一个重复的记录被添加到数据库中。在POST之后重定向是避免此种情况的有用的模式：在成功执行一个POST请求之后，将用户重定向到另一个页面而不是直接返回HTML。&lt;/p&gt;  &lt;p&gt;自定义验证规则&lt;/p&gt;  &lt;p&gt;&nbsp;&nbsp;&nbsp; 想想我们已经建立了反馈表单，并且电子邮件也已经嵌入了。只有一个问题：某些邮件只有一或者两个词语，并不能形成包含详细信息的邮件。我们准备实施一个新的验证规则：4个词语或者更多，谢谢。&lt;/p&gt;  &lt;p&gt;&nbsp;&nbsp;&nbsp;
                                                        有很多种方法在Django表单中嵌入自定义验证规则。如果我们的规则是要一次又一次被重复使用的，我们可以创建一个自定义的域类型。大多数的自定义验证规则是一次性的，因此，可以直接绑定在表单类中。&lt;/p&gt;  &lt;p&gt;&nbsp;&nbsp;&nbsp; 我们想要在message域添加验证规则，因此我们需要给我们的表单添加一个clean_message方法：&lt;/p&gt;  &lt;pre&gt;&lt;span style=&quot;color: #0000ff&quot;&gt;class&lt;/span&gt; ContactForm(forms.Form):     topic = forms.ChoiceField(choices=TOPIC_CHOICES)     message = forms.CharField(widget=forms.Textarea())     sender = forms.EmailField(required=False)      &lt;span style=&quot;color: #0000ff&quot;&gt;def&lt;/span&gt; clean_message(self):         message = self.clean_data.get('message', '')
                                                        num_words = len(message.&lt;span style=&quot;color: #0000ff&quot;&gt;split&lt;/span&gt;())         &lt;span style=&quot;color: #0000ff&quot;&gt;if&lt;/span&gt; num_words &lt; 4:             raise forms.ValidationError(&quot;&lt;span style=&quot;color: #8b0000&quot;&gt;Not enough words!&lt;/span&gt;&quot;)         &lt;span style=&quot;color: #0000ff&quot;&gt;return&lt;/span&gt; message&lt;/pre&gt;  &lt;p&gt;&nbsp;&nbsp;&nbsp; 这个新的方法会在默认的域验证方法（在这个例子中是CharField的验证方法）之后被调用。因为域数据已经部分地被处理了，我们需要我们需要把它从表单的clean_data字典中取出来。&lt;/p&gt;  &lt;p&gt;&nbsp;&nbsp;&nbsp;
                                                        我们使用len()和split()组合来计算单词的数目。如果用户输入了太少的单词，我们就会抛出一个&lt;tt&gt;ValidationError&lt;/tt&gt;异常。附加在这个异常的字符串会作为错误列表中的一个条目显示给用户。&lt;/p&gt;  &lt;p&gt;&nbsp;&nbsp;&nbsp; 在方法的末尾明确地返回出错域的值是十分重要的。这允许我们修改（或者把它转换为一个不同的Python类型）我们的自定义验证方法中的值。如果我们忘记了返回语句，None会被返回，原来的值就会丢失。&lt;/p&gt;  &lt;p&gt;自定义外观和风格&lt;/p&gt;  &lt;p&gt;&nbsp;&nbsp;&nbsp; 自定义表单外观最快速的途径是使用CSS。错误列表尤其可以使用一些视觉增强在定制外观，&lt;ul&gt;标签有一个errorlist类属性专门用来做这件事。接下来的CSS代码定制了错误输出：&lt;/p&gt;  &lt;pre&gt;&lt;&lt;span style=&quot;color:
                                                        #800000&quot;&gt;style&lt;/span&gt; &lt;span style=&quot;color: #800000&quot;&gt;type&lt;/span&gt;=&quot;&lt;span style=&quot;color: #800000&quot;&gt;text&lt;/span&gt;/&lt;span style=&quot;color: #800000&quot;&gt;css&lt;/span&gt;&quot;&gt;     &lt;span style=&quot;color: #800000&quot;&gt;ul&lt;/span&gt;.&lt;span style=&quot;color: #800000&quot;&gt;errorlist&lt;/span&gt; {         &lt;span style=&quot;color: #ff0000&quot;&gt;margin&lt;/span&gt;: &lt;span style=&quot;color: #0000ff&quot;&gt;0&lt;/span&gt;;         &lt;span style=&quot;color: #ff0000&quot;&gt;padding&lt;/span&gt;: &lt;span style=&quot;color: #0000ff&quot;&gt;0&lt;/span&gt;;     }     .&lt;span style=&quot;color: #800000&quot;&gt;errorlist&lt;/span&gt;
                                                        &lt;span style=&quot;color: #800000&quot;&gt;li&lt;/span&gt; {         &lt;span style=&quot;color: #ff0000&quot;&gt;background-color&lt;/span&gt;: &lt;span style=&quot;color: #0000ff&quot;&gt;red&lt;/span&gt;;         &lt;span style=&quot;color: #ff0000&quot;&gt;color&lt;/span&gt;: &lt;span style=&quot;color: #0000ff&quot;&gt;white&lt;/span&gt;;         &lt;span style=&quot;color: #ff0000&quot;&gt;display&lt;/span&gt;: &lt;span style=&quot;color: #0000ff&quot;&gt;block&lt;/span&gt;;         &lt;span style=&quot;color: #ff0000&quot;&gt;font-size&lt;/span&gt;: &lt;span style=&quot;color: #0000ff&quot;&gt;10px&lt;/span&gt;;         &lt;span style=&quot;color: #ff0000&quot;&gt;margin&lt;/span&gt;: &lt;span style=&quot;color:
                                                        #0000ff&quot;&gt;0 0 3px&lt;/span&gt;;         &lt;span style=&quot;color: #ff0000&quot;&gt;padding&lt;/span&gt;: &lt;span style=&quot;color: #0000ff&quot;&gt;4px 5px&lt;/span&gt;;     } &lt;/&lt;span style=&quot;color: #800000&quot;&gt;style&lt;/span&gt;&gt;&lt;/pre&gt;  &lt;p&gt;&nbsp;&nbsp;&nbsp;&nbsp; 虽然为我们生成表单的HTML代码是很方便的，大多数情况下默认的渲染并不适合我们的应用。&lt;tt&gt;{{ form.as_table }}和其类似的标签是我们开发应用时非常有用的捷径，但是有关表单显示的所有东西都可以被覆盖，大部分针对模板自身。&lt;/tt&gt;&lt;/p&gt;  &lt;p&gt;&lt;tt&gt;&nbsp;&nbsp;&nbsp; 每一个域部件（&lt;tt&gt;&lt;input type=&quot;text&quot;&gt;&lt;/tt&gt;, &lt;tt&gt;&lt;select&gt;&lt;/tt&gt;,
                                                        &lt;tt&gt;&lt;textarea&gt;&lt;/tt&gt;，或类似的东西）都可以通过访问&lt;tt&gt;{{ form.fieldname }}&lt;/tt&gt;独立地渲染。与域绑定的错误通过&lt;tt&gt;{{ form.fieldname.errors }}&lt;/tt&gt;访问。我们可以使用这些表单变量为我们的联系人表单构建一个自定义的模板：&lt;/tt&gt;&lt;/p&gt;  &lt;pre&gt;&lt;span style=&quot;color: #0000ff&quot;&gt;&lt;&lt;/span&gt;&lt;span style=&quot;color: #800000&quot;&gt;form&lt;/span&gt; &lt;span style=&quot;color: #ff0000&quot;&gt;action&lt;/span&gt;=&lt;span style=&quot;color: #0000ff&quot;&gt;&quot;.&quot;&lt;/span&gt; &lt;span style=&quot;color: #ff0000&quot;&gt;method&lt;/span&gt;=&lt;span style=&quot;color: #0000ff&quot;&gt;&quot;POST&quot;&lt;/span&gt;&lt;span style=&quot;color:
                                                        #0000ff&quot;&gt;&gt;&lt;/span&gt;     &lt;span style=&quot;color: #0000ff&quot;&gt;&lt;&lt;/span&gt;&lt;span style=&quot;color: #800000&quot;&gt;div&lt;/span&gt; &lt;span style=&quot;color: #ff0000&quot;&gt;class&lt;/span&gt;=&lt;span style=&quot;color: #0000ff&quot;&gt;&quot;fieldWrapper&quot;&lt;/span&gt;&lt;span style=&quot;color: #0000ff&quot;&gt;&gt;&lt;/span&gt;         {{ form.topic.errors }}         &lt;span style=&quot;color: #0000ff&quot;&gt;&lt;&lt;/span&gt;&lt;span style=&quot;color: #800000&quot;&gt;label&lt;/span&gt; &lt;span style=&quot;color: #ff0000&quot;&gt;for&lt;/span&gt;=&lt;span style=&quot;color: #0000ff&quot;&gt;&quot;id_topic&quot;&lt;/span&gt;&lt;span style=&quot;color:
                                                        #0000ff&quot;&gt;&gt;&lt;/span&gt;Kind of feedback:&lt;span style=&quot;color: #0000ff&quot;&gt;&lt;/&lt;/span&gt;&lt;span style=&quot;color: #800000&quot;&gt;label&lt;/span&gt;&lt;span style=&quot;color: #0000ff&quot;&gt;&gt;&lt;/span&gt;         {{ form.topic }}     &lt;span style=&quot;color: #0000ff&quot;&gt;&lt;/&lt;/span&gt;&lt;span style=&quot;color: #800000&quot;&gt;div&lt;/span&gt;&lt;span style=&quot;color: #0000ff&quot;&gt;&gt;&lt;/span&gt;     &lt;span style=&quot;color: #0000ff&quot;&gt;&lt;&lt;/span&gt;&lt;span style=&quot;color: #800000&quot;&gt;div&lt;/span&gt; &lt;span style=&quot;color: #ff0000&quot;&gt;class&lt;/span&gt;=&lt;span style=&quot;color:
                                                        #0000ff&quot;&gt;&quot;fieldWrapper&quot;&lt;/span&gt;&lt;span style=&quot;color: #0000ff&quot;&gt;&gt;&lt;/span&gt;         {{ form.message.errors }}         &lt;span style=&quot;color: #0000ff&quot;&gt;&lt;&lt;/span&gt;&lt;span style=&quot;color: #800000&quot;&gt;label&lt;/span&gt; &lt;span style=&quot;color: #ff0000&quot;&gt;for&lt;/span&gt;=&lt;span style=&quot;color: #0000ff&quot;&gt;&quot;id_message&quot;&lt;/span&gt;&lt;span style=&quot;color: #0000ff&quot;&gt;&gt;&lt;/span&gt;Your message:&lt;span style=&quot;color: #0000ff&quot;&gt;&lt;/&lt;/span&gt;&lt;span style=&quot;color: #800000&quot;&gt;label&lt;/span&gt;&lt;span style=&quot;color: #0000ff&quot;&gt;&gt;&lt;/span&gt;         {{ form.message }}     &lt;span
                                                        style=&quot;color: #0000ff&quot;&gt;&lt;/&lt;/span&gt;&lt;span style=&quot;color: #800000&quot;&gt;div&lt;/span&gt;&lt;span style=&quot;color: #0000ff&quot;&gt;&gt;&lt;/span&gt;     &lt;span style=&quot;color: #0000ff&quot;&gt;&lt;&lt;/span&gt;&lt;span style=&quot;color: #800000&quot;&gt;div&lt;/span&gt; &lt;span style=&quot;color: #ff0000&quot;&gt;class&lt;/span&gt;=&lt;span style=&quot;color: #0000ff&quot;&gt;&quot;fieldWrapper&quot;&lt;/span&gt;&lt;span style=&quot;color: #0000ff&quot;&gt;&gt;&lt;/span&gt;         {{ form.sender.errors }}         &lt;span style=&quot;color: #0000ff&quot;&gt;&lt;&lt;/span&gt;&lt;span style=&quot;color: #800000&quot;&gt;label&lt;/span&gt; &lt;span style=&quot;color:
                                                        #ff0000&quot;&gt;for&lt;/span&gt;=&lt;span style=&quot;color: #0000ff&quot;&gt;&quot;id_sender&quot;&lt;/span&gt;&lt;span style=&quot;color: #0000ff&quot;&gt;&gt;&lt;/span&gt;Your email (optional):&lt;span style=&quot;color: #0000ff&quot;&gt;&lt;/&lt;/span&gt;&lt;span style=&quot;color: #800000&quot;&gt;label&lt;/span&gt;&lt;span style=&quot;color: #0000ff&quot;&gt;&gt;&lt;/span&gt;         {{ form.sender }}     &lt;span style=&quot;color: #0000ff&quot;&gt;&lt;/&lt;/span&gt;&lt;span style=&quot;color: #800000&quot;&gt;div&lt;/span&gt;&lt;span style=&quot;color: #0000ff&quot;&gt;&gt;&lt;/span&gt;     &lt;span style=&quot;color: #0000ff&quot;&gt;&lt;&lt;/span&gt;&lt;span style=&quot;color:
                                                        #800000&quot;&gt;p&lt;/span&gt;&lt;span style=&quot;color: #0000ff&quot;&gt;&gt;&lt;/span&gt;&lt;span style=&quot;color: #0000ff&quot;&gt;&lt;&lt;/span&gt;&lt;span style=&quot;color: #800000&quot;&gt;input&lt;/span&gt; &lt;span style=&quot;color: #ff0000&quot;&gt;type&lt;/span&gt;=&lt;span style=&quot;color: #0000ff&quot;&gt;&quot;submit&quot;&lt;/span&gt; &lt;span style=&quot;color: #ff0000&quot;&gt;value&lt;/span&gt;=&lt;span style=&quot;color: #0000ff&quot;&gt;&quot;Submit&quot;&lt;/span&gt;&lt;span style=&quot;color: #0000ff&quot;&gt;&gt;&lt;/span&gt;&lt;span style=&quot;color: #0000ff&quot;&gt;&lt;/&lt;/span&gt;&lt;span style=&quot;color: #800000&quot;&gt;p&lt;/span&gt;&lt;span style=&quot;color:
                                                        #0000ff&quot;&gt;&gt;&lt;/span&gt; &lt;span style=&quot;color: #0000ff&quot;&gt;&lt;/&lt;/span&gt;&lt;span style=&quot;color: #800000&quot;&gt;form&lt;/span&gt;&lt;span style=&quot;color: #0000ff&quot;&gt;&gt;&lt;/span&gt;&lt;/pre&gt;  &lt;p&gt;&lt;span style=&quot;color: #0000ff&quot;&gt;&nbsp;&nbsp; &lt;/span&gt;&lt;tt&gt;{{ form.message.errors }}将被作为&lt;tt&gt;&lt;ul class=&quot;errorlist&quot;&gt;&lt;/tt&gt;显示，如果错误存在并且一个空白字符串如果域是有效的（或者表单时无界的）。我们也可以把&lt;tt&gt;form.message.errors&lt;/tt&gt;当作一个布尔变量来处理，或者甚至把它作为一个列表来迭代，例如：&lt;/tt&gt;&lt;/p&gt;  &lt;pre&gt;&lt;span style=&quot;color: #0000ff&quot;&gt;&lt;&lt;/span&gt;&lt;span style=&quot;color:
                                                        #800000&quot;&gt;div&lt;/span&gt; &lt;span style=&quot;color: #ff0000&quot;&gt;class&lt;/span&gt;=&lt;span style=&quot;color: #0000ff&quot;&gt;&quot;fieldWrapper{% if form.message.errors %} errors{% endif %}&quot;&lt;/span&gt;&lt;span style=&quot;color: #0000ff&quot;&gt;&gt;&lt;/span&gt;     {% if form.message.errors %}         &lt;span style=&quot;color: #0000ff&quot;&gt;&lt;&lt;/span&gt;&lt;span style=&quot;color: #800000&quot;&gt;ol&lt;/span&gt;&lt;span style=&quot;color: #0000ff&quot;&gt;&gt;&lt;/span&gt;         {% for error in form.message.errors %}             &lt;span style=&quot;color: #0000ff&quot;&gt;&lt;&lt;/span&gt;&lt;span style=&quot;color: #800000&quot;&gt;li&lt;/span&gt;&lt;span style=&quot;color:
                                                        #0000ff&quot;&gt;&gt;&lt;/span&gt;&lt;span style=&quot;color: #0000ff&quot;&gt;&lt;&lt;/span&gt;&lt;span style=&quot;color: #800000&quot;&gt;strong&lt;/span&gt;&lt;span style=&quot;color: #0000ff&quot;&gt;&gt;&lt;/span&gt;{{ error|escape }}&lt;span style=&quot;color: #0000ff&quot;&gt;&lt;/&lt;/span&gt;&lt;span style=&quot;color: #800000&quot;&gt;strong&lt;/span&gt;&lt;span style=&quot;color: #0000ff&quot;&gt;&gt;&lt;/span&gt;&lt;span style=&quot;color: #0000ff&quot;&gt;&lt;/&lt;/span&gt;&lt;span style=&quot;color: #800000&quot;&gt;li&lt;/span&gt;&lt;span style=&quot;color: #0000ff&quot;&gt;&gt;&lt;/span&gt;         {% endfor %}         &lt;span style=&quot;color: #0000ff&quot;&gt;&lt;/&lt;/span&gt;&lt;span
                                                        style=&quot;color: #800000&quot;&gt;ol&lt;/span&gt;&lt;span style=&quot;color: #0000ff&quot;&gt;&gt;&lt;/span&gt;     {% endif %}     {{ form.message }} &lt;span style=&quot;color: #0000ff&quot;&gt;&lt;/&lt;/span&gt;&lt;span style=&quot;color: #800000&quot;&gt;div&lt;/span&gt;&lt;span style=&quot;color: #0000ff&quot;&gt;&gt;&lt;/span&gt;&lt;/pre&gt;  &lt;p&gt;&lt;font face=&quot;Courier New&quot;&gt;&nbsp;&nbsp;&nbsp; 如果发生验证错误，这将会在&lt;div&gt;容器中添加一个&quot;errors&quot;类并且显示一个排序的错误列表。&lt;/font&gt;&lt;/p&gt;  &lt;p&gt;&lt;font face=&quot;Courier New&quot;&gt;从模型创建表单&lt;/font&gt;&lt;/p&gt;  &lt;p&gt;&lt;font face=&quot;Courier New&quot;&gt;&nbsp;&nbsp;&nbsp;
                                                        让我们创建一些更有趣的东西：一个提交一个新的出版社到我们第5章中的book应用的新出版社。&lt;/font&gt;&lt;/p&gt;  &lt;p&gt;&lt;font face=&quot;Courier New&quot;&gt;&nbsp;&nbsp;&nbsp; Django在这里试图遵循的软件开发中的一个重要的经验规则是不要重复你自己(DRY)。Andy Hunt 和 Dave Thomas 在&lt;i&gt; Pragmatic Programmer &lt;/i&gt;对此作了如下定义：&lt;/font&gt;&lt;/p&gt;  &lt;p&gt;&lt;font face=&quot;Courier New&quot;&gt;每一块知识，都必须有一个单一的、明确的、权威的表现体系。&lt;/font&gt;&lt;/p&gt;  &lt;p&gt;&lt;font face=&quot;Courier New&quot;&gt;&nbsp;&nbsp;&nbsp;
                                                        我们的&lt;tt&gt;Publisher&lt;/tt&gt;模型告诉我们一个出版社有一个名字，地址，省或者州，国家，和网站。在表单定义中重复这些信息会打破DRY规则。取而代之，我们可以使用一个有用的shortcut:form_for_model():&lt;/font&gt;&lt;/p&gt;  &lt;pre&gt;from models &lt;span style=&quot;color: #0000ff&quot;&gt;import&lt;/span&gt; Publisher from django.newforms &lt;span style=&quot;color: #0000ff&quot;&gt;import&lt;/span&gt; form_for_model  PublisherForm = form_for_model(Publisher)&lt;/pre&gt;  &lt;p&gt;&lt;tt&gt;&nbsp;&nbsp;&nbsp; PublisherForm是一个Form子类，如同我们在前面手动创建的&lt;tt&gt;ContactForm&lt;/tt&gt;类。我们可以以同样的方式使用它：&lt;/tt&gt;&lt;/p&gt;  &lt;pre&gt;from forms &lt;span style=&quot;color:
                                                        #0000ff&quot;&gt;import&lt;/span&gt; PublisherForm  &lt;span style=&quot;color: #0000ff&quot;&gt;def&lt;/span&gt; add_publisher(request):     &lt;span style=&quot;color: #0000ff&quot;&gt;if&lt;/span&gt; request.method == 'POST':         form = PublisherForm(request.POST)         &lt;span style=&quot;color: #0000ff&quot;&gt;if&lt;/span&gt; form.is_valid():             form.save()             &lt;span style=&quot;color: #0000ff&quot;&gt;return&lt;/span&gt; HttpResponseRedirect('/add_publisher/thanks/')     &lt;span style=&quot;color: #0000ff&quot;&gt;else&lt;/span&gt;:         form = PublisherForm()     &lt;span style=&quot;color: #0000ff&quot;&gt;return&lt;/span&gt; render_to_response('books/add_publisher.html', {'form':
                                                        form})&lt;/pre&gt;  &lt;p&gt;&lt;tt&gt;&nbsp;&nbsp;&nbsp; add_publisher.html文件和我们原来的contact.html模板几乎是一模一样的，所以在这里忽略了。还要记得在URLconf中添加一个新的模式：&lt;/tt&gt;&lt;/p&gt;  &lt;pre&gt;(r'^add_publisher/$', 'mysite.books.views.add_publisher').&lt;/pre&gt;  &lt;p&gt;&lt;font face=&quot;Courier New&quot;&gt;&nbsp;&nbsp;&nbsp; 这里展示了另一个shortcut。因为由模型生成的表单通常使用来保存新的模型实例到数据库中的，由&lt;tt&gt;form_for_model&lt;/tt&gt;创建的表单类包含一个方便的save()方法。它处理了通常的情形；如果你想做一些与提交的数据密切相关的事情，你可以忽略它。&lt;/font&gt;&lt;/p&gt;  &lt;p&gt;&lt;tt&gt;&nbsp;&nbsp;&nbsp;
                                                        form_for_instance()是一个从一个模型实例创建预填写的表单相关的方法。这对创建&ldquo;编辑&rdquo;表单很有用。&lt;/tt&gt;&lt;/p&gt;  &lt;p&gt;&lt;tt&gt;接下来是什么？&lt;/tt&gt;&lt;/p&gt;  &lt;p&gt;&lt;tt&gt;&nbsp;&nbsp;&nbsp; 本章是本书的引导部分的终结。接下来的13章处理各类高级主题，包括生成非HTML内容（第11章），安全（第19章），和部署（第20章）。&lt;/tt&gt;&lt;/p&gt;  &lt;p&gt;&lt;tt&gt;&nbsp;&nbsp;&nbsp; 在前面的7章之后，你应该已经知道了足够多的东西来写你自己的Django项目。本书中剩余的资料会填补你需要的缺失的部分。&lt;/tt&gt;&lt;/p&gt;  &lt;p&gt;&lt;tt&gt;&nbsp;&nbsp;&nbsp; 我们会从第8章开始，回头更仔细地看看视图和URLconf(在第3章首次介绍)。&lt;/tt&gt;&lt;/p&gt;
                                                        &lt;p&gt;=================================================================== &lt;/p&gt;  &lt;p&gt;基于2008年5月11日所见之&lt;a href=&quot;http://www.djangobook.com&quot; _fcksavedurl=&quot;http://www.djangobook.com&quot;&gt;www.djangobook.com&lt;/a&gt;版本翻译。 &lt;/p&gt;  &lt;p&gt;=================================================================== &lt;/p&gt;  &lt;div class=&quot;wlWriterSmartContent&quot; id=&quot;scid:0767317B-992E-4b12-91E0-4F059A8CECA8:1df40999-2061-4af2-8093-4277a562aa51&quot; style=&quot;padding-right: 0px; display: inline; padding-left: 0px; padding-bottom: 0px; margin: 0px; padding-top: 0px&quot;&gt;Technorati 标签: &lt;a href=&quot;http://technorati.com/tags/Django&quot;
                                                        _fcksavedurl=&quot;http://technorati.com/tags/Django&quot; rel=&quot;tag&quot;&gt;Django&lt;/a&gt;,&lt;a href=&quot;http://technorati.com/tags/Book&quot; _fcksavedurl=&quot;http://technorati.com/tags/Book&quot; rel=&quot;tag&quot;&gt;Book&lt;/a&gt;,&lt;a href=&quot;http://technorati.com/tags/Web&quot; _fcksavedurl=&quot;http://technorati.com/tags/Web&quot; rel=&quot;tag&quot;&gt;Web&lt;/a&gt;,&lt;a href=&quot;http://technorati.com/tags/Python&quot; _fcksavedurl=&quot;http://technorati.com/tags/Python&quot; rel=&quot;tag&quot;&gt;Python&lt;/a&gt;,&lt;a href=&quot;http://technorati.com/tags/MVC&quot; _fcksavedurl=&quot;http://technorati.com/tags/MVC&quot; rel=&quot;tag&quot;&gt;MVC&lt;/a&gt;&lt;/div&gt;
                                                        &lt;p&gt;&nbsp;&lt;/p&gt;  &lt;p&gt;&nbsp;&lt;/p&gt;  &lt;p&gt;&nbsp;&lt;/p&gt;  &lt;p&gt;&nbsp;&lt;/p&gt;  &lt;p&gt;&nbsp;&lt;/p&gt;  &lt;p&gt;&nbsp;&lt;/p&gt;  &lt;p&gt;&nbsp;&lt;/p&gt;  &lt;p&gt;&nbsp;&lt;/p&gt;  &lt;p&gt;&nbsp;&lt;/p&gt;  &lt;p&gt;&nbsp;&lt;/p&gt;  &lt;p&gt;&nbsp;&lt;/p&gt;  &lt;p&gt;&nbsp;&lt;/p&gt;  &lt;p&gt;&nbsp;&lt;/p&gt;  &lt;p&gt;&nbsp;&lt;/p&gt;  &lt;p&gt;=================================================================== &lt;/p&gt;  &lt;p&gt;基于2008年5月11日所见之&lt;a href=&quot;http://www.djangobook.com&quot; _fcksavedurl=&quot;http://www.djangobook.com&quot;&gt;www.djangobook.com&lt;/a&gt;版本翻译。 &lt;/p&gt;  &lt;p&gt;===================================================================
                                                        &lt;/p&gt;</textarea></font></p>
                                                            </form>

                                                            </table>
                                                            </font></p>

